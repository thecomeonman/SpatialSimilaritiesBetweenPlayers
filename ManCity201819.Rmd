---
title: "Similar Passing Style to Man City Players"
author: "Aditya Kothari"
date: "4 July 2019"
output: html_document
---

```{r Setup, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 15, fig.height = 8, results = 'hide'}
   
rm(list = ls())

library(data.table)
library(emdist)
library(snow)
library(snowfall)
library(ggplot2)
library(scales)
library(knitr)
library(clue)
theme_set(theme_bw(12))

knitr::knit_meta(class=NULL, clean = TRUE)
options(knitr.duplicate.label = 'allow')

```

```{r ParametersFunctions, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 15, fig.height = 8, results = 'asis'}

cPostCodeFolderLocation = '/media/ask/Data/Personal/Projects/Personal/AnalysingFootballData/EMDRelated/'
cPostDataFolderLocation = '/media/ask/Data/Personal/Projects/Personal/NoSuchThingAs4231'

source(paste0(cPostCodeFolderLocation, '/Common.R'))
read_chunk(paste0(cPostCodeFolderLocation, '/CommonChunksSimilarPlayers.R'))

cTeamName = 'Man City'
# 'Liverpool'

```

```{r DataLoading, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 15, fig.height = 8, results = 'asis'}

load(paste0(
   cPostDataFolderLocation,
   '/Data/FormationMatchingData/ProcessedData.Rdata'
))

iTeamId = dtMatches[teamName == cTeamName, teamId[1]]

# rm(dtPasses)
# dtSNOMapping = dtPasses[, list(SNO = SNO[1]), list(matchId = matchId, teamId = teamId)]
# rm(dtPasses)
# rm(dtPlayers)
# rm(dtFormationDetails)
# rm(dtFormationSets)


load(
   paste0(
      cPostDataFolderLocation,
      '/Data/FormationMatchingData/DistanceFileNames.Rdata'
   )
)


dtDistanceSummary = rbindlist(
   lapply(
      dtDistanceFileNames[teamId1 %in% iTeamId, rev(sort(unique(SNO2)))],
      function ( iSNO2 ) {

         # print(iSNO2)
         # print(Sys.time())

         cTempFile = paste0(
            cAllMatchDistanceFolderName,
            '/', 
            dtSNOMapping[
               SNO == iSNO2,
               paste0(
                  matchId, '_', teamId
               )
            ],
            '.Rdata'
         )

         load(cTempFile)

         # dtDistanceSummary[, c('DistancePassToXY','DistancePassXYSummary','DistanceReceiveAtXYSummary','DistanceReceiveFromXY') := NULL]

         # dtDistanceSummary = dtDistanceSummary[!is.infinite(Distance) & !is.na(Distance)]

         # dtDistanceSummary[Match == T, MatchDistance := Distance]
         # dtDistanceSummary[Match == F, MatchDistance := 1000000]

         dtDistanceSummary = dtDistanceSummary[
            SNO1 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)] |
            SNO2 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)]
         ]
         
         dtDistanceSummary

      }
   ),
   fill = T
)

rm(dtDistanceFileNames)

dtDistanceSummary = rbind(
   dtDistanceSummary[
      SNO1 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)] &
      !(SNO2 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)])
   ],
   dtDistanceSummary[      
      SNO2 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)] &
      !(SNO1 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)]),
      list(
         playerId1 = playerId2,
         playerId2 = playerId1,
         SNO1 = SNO2,
         SNO2 = SNO1,
         Distance,
         Match,
         DistanceReceiveFromXY,
         DistanceReceiveAtXYSummary,
         DistancePassXYSummary,
         DistancePassToXY
      )
   ],
   dtDistanceSummary[
      SNO2 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)] &
      SNO1 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)]
   ],
   dtDistanceSummary[
      SNO2 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)] &
      SNO1 %in% dtSNOMapping[teamId %in% iTeamId, unique(SNO)],
      list(
         playerId1 = playerId2,
         playerId2 = playerId1,
         SNO1 = SNO2,
         SNO2 = SNO1,
         Distance,
         Match,
         DistanceReceiveFromXY,
         DistanceReceiveAtXYSummary,
         DistancePassXYSummary,
         DistancePassToXY
      )
   ],
   fill = T
)

# dtDistanceSummary[, DistancePassesMade := ( (DistancePassToXY ^ 2) + (DistancePassXYSummary ^ 2)) ^ 0.5]

dtPlayers[
   name %in% dtPlayers[, length(unique(playerId)), name][V1 > 1, name],
   name := paste0(name, rank(playerId)),
   name
]

dtDistanceSummary = merge(
   dtDistanceSummary,
   merge(
      dtSNOMapping[, list(SNO2 = SNO, teamId2 = teamId, matchId2 = matchId, Tournament2 = Tournament)],
      dtPlayers[, list(name2 = name, playerId2 = playerId, teamId2 = teamId, matchId2 = matchId)],
      c('matchId2','teamId2')
   )[,
      list(name2, playerId2, Tournament2, SNO2)
   ],
   c('playerId2', 'SNO2')
)

dtDistanceSummary = merge(
   dtDistanceSummary,
   merge(
      dtSNOMapping[, list(matchId2 = matchId, teamId2 = teamId, SNO2 = SNO)],
      dtMatches[, list(matchId2 = as.integer(matchId), teamId2 = as.integer(teamId), teamName2 = teamName)],
      c('matchId2','teamId2')
   )[, list(SNO2, teamId2, teamName2)],
   c('SNO2')     
)

```

```{r DataFiltering, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 15, fig.height = 8, results = 'asis'}

dtPreferredPositionMatches = merge(
     dtFormationDetails[playerId %in% dtDistanceSummary[, unique(playerId1)]],
     dtFormationSets,
     c('formationIndex','teamId','matchId')
 )[formationSlots != 0]

dtPreferredPositionMatches = merge(
   dtPreferredPositionMatches,
   merge(
      dtDistanceSummary[, list(SNO = unique(SNO1))],
      dtSNOMapping[, list(SNO = SNO, matchId = matchId)],
      c('SNO')
   )[, list(matchId)],
   c('matchId')
)

dtPreferredPositionMatches = merge(
   dtPreferredPositionMatches,
   dtPreferredPositionMatches[, .N, list(playerId, formationName, formationSlots)][, .SD[which.max(N)], playerId],
   c('playerId','formationSlots', 'formationName')
)[, list(matchId, teamId, playerId, formationName, formationSlots)]

dtDistanceSummary = merge(
   dtDistanceSummary,
   merge(
      dtSNOMapping,
      dtPreferredPositionMatches,
      c('matchId','teamId')
   )[, list(playerId1 = playerId, SNO1 = SNO)],
   c('playerId1','SNO1')
)

dtPlayersOfInterest = merge(
   dtPlayers[, list(name = name[1]), playerId],
   dtDistanceSummary[, list(Appearances = length(unique(SNO1))), list(playerId = playerId1)],
   'playerId'
)[
   order(Appearances)
][
   Appearances >= 5
]

dtPlayersOfInterest = merge(
   dtPlayersOfInterest,
   dtPreferredPositionMatches[, list(formationName = formationName[1], formationSlots = formationSlots[1]), playerId],
   'playerId'
)

```

## Motivation

Transfer rumours

## Methodology

<a href = "https://thecomeonman.github.io/SpatialSimilaritiesBetweenPlayers/">My measure of similarity in passing style</a>

I've included the selected player's statistics in both the plots as well to have some reference. I've excluded comparisons between the same match since that would lead to the distance between those performances all being 0 instead of telling us about the match to match variation in his game.

One thing to note is that this isn't an overall similarity of two players but a similarity between the way the two players played in two paritcular matches. Depending on how we choose to go from a many matches to many matches comparison to a one player to one player comparison, we could end up with different conclusions. The many to many that I compare is the closest match that every player had for each of the selected palyer's performance and look at that distribution. Players who have played in various roles that the selected player himself has played in, should have at least one match very similar to each of the selected player's performances. Players who have played in some subset of roles that the selected player has played in but haven't had to play in the some of the other roles will have some very similar points when the matches with the similar roles are compared, but also some points farther away for the matches where a similar role wasn't played in. Getting from this many to many to the one to one is something I'll talk about later after we've seen the numbers.

## Results {.tabset .tabset-fade .tabset-pills}


```{r PlayerPlot, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

if ( exists('iPlayerIdIndex') ) {

   if ( iPlayerIdIndex <= nrow(dtPlayersOfInterest) ) {
      
      print(dtPlayersOfInterest[iPlayerIdIndex])
         
      dtDistanceSummary[,
         name2Factor := factor(
            name2,
            # levels = dtDistanceSummary[
            #    playerId1 == iPlayerId, 
            #    median(Distance), 
            #    list(playerId2, name2)
            # ][
            #    order(V1), 
            #    name2
            # ],
            levels = dtDistanceSummary[
               playerId1 == iPlayerId
            ][
            # dtDistanceSummary[
               Match == T & SNO1 != SNO2,
               .SD[which.min(Distance)],
               list(playerId2, SNO1)
            ][, 
               median(Distance), 
               list(playerId2, name2)
            ][
               order(V1), 
               c(
                  dtPlayersOfInterest[iPlayerIdIndex, name],
                  setdiff(
                     name2,
                     dtPlayersOfInterest[iPlayerIdIndex, name]
                  )
               )
            ],
            ordered = T
         )
      ]
   
      dtComparisons = merge(
         dtDistanceSummary[
            playerId1 == iPlayerId
         ],
         dtDistanceSummary[
            playerId1 == iPlayerId,
            list(
               # .N,
               # MatchProportion = sum(Match) / .N,
               UniquePairings1_pct = length(unique(SNO1[Match == T])) / length(unique(SNO1)),
               UniquePairings2_pct = length(unique(SNO2[Match == T])) / length(unique(SNO2)),
               UniquePairings2 = length(unique(SNO2[Match == T]))
            ),
            list(
               playerId2
            )
         ][
            # MatchProportion > 0.4 & 
            (
               UniquePairings1_pct >= 0.33 &
               UniquePairings2_pct >= 0.33 &
               UniquePairings2 >= 5
            ) | (
               playerId2 == iPlayerId
            ) |
            F
         ][
            # rev(order(MatchProportion))
            ,
            list(
               playerId2
               # MatchProportion
            )
         ],
         'playerId2'
      )
      
      qwe = melt(
         dtComparisons[
            name2 %in% levels(name2Factor)[sapply(levels(name2Factor), function(x) x %in% name2)][1:50] |
            playerId2 %in% iPlayerId
         ][
         # dtDistanceSummary[
            Match == T & SNO1 != SNO2,
            .SD[which.min(Distance)],
            list(playerId2, SNO1)
         ][
            # playerId2 %in% dtDistanceSummary[, min(DistancePassesMade), playerId2][V1 <= 9, playerId2]
         ][
            # MatchProportion > 0.25
         ][
            # playerId2 == iPlayerId | 
            # Tournament2 == cTournament |
            ,
            list(
               playerId2,
               name2Factor,
               name2,
               teamName2,
               Tournament2,
               DistanceReceiveFromXY,
               DistanceReceiveAtXYSummary,
               DistancePassXYSummary,
               DistancePassToXY,
               Distance 
            )
         ],
         id.vars = c('playerId2','name2','teamName2','name2Factor','Tournament2') 
      )
   
   
      pTournament = ggplot(
         qwe
      ) + 
         geom_boxplot(
            aes(
               # x = factor(playerId2),
               x = name2Factor,
               y = value,
               group = paste(name2, variable),
               fill = variable,
               # playerId2 == iPlayerId
            ), 
            outlier.shape = NA,
            # width = 0.9,
            position = position_dodge()
         ) +
         theme(
            axis.text.x = element_text(
               angle = 90, 
               hjust = 1, 
               vjust = 0.5
            ),
            legend.position = 'bottom'
         ) +
         # facet_wrap(~Tournament2, ncol = 1, scale = 'free_x') + 
         scale_colour_discrete(guide = 'none') +
         # facet_wrap(~variable, ncol = 1, scales = 'free_y') + 
         scale_x_discrete(
            breaks = dtComparisons[, name2[1], name2Factor][order(name2Factor)][, V1],
            labels = dtComparisons[, list(name2[1], paste(unique(teamName2), collapse = ', ')), name2Factor][order(name2Factor), paste0(V1, ' (', V2, ')')]
         ) +
         # coord_cartesian() +
         coord_flip(ylim = c(0, 30)) + 
         labs(
            # title = cTournament,
            caption = 'Analysis by TheComeOnMan'
         ) +
         # coord_cartesian(ylim = c(NA, 40)) +
         geom_blank()

      print(pTournament)
         

   }

} else {
   
   iPlayerIdIndex = 0
   
}

```


```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```

```{r cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 6, results = 'asis'}

iPlayerIdIndex = iPlayerIdIndex + 1
iPlayerId = dtPlayersOfInterest[iPlayerIdIndex, playerId]

```

### `r dtPlayersOfInterest[iPlayerIdIndex, name]` {.tabset .tabset-fade .tabset-pills}

```{r ref.label = 'PlayerPlot', cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 25, results = 'asis'}
```
